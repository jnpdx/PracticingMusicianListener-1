function concat(t,e){return t.concat(e)}VF=Vex.Flow;var EasyScoreUtil=function(){this.scorePositionInitialX=60,this.scorePositionInitialY=20,this.scorePositionX=0,this.scorePositionY=0,this.positionInLine=0,this.scorePositionCurrentLine=0,this.measureCounter=0,this.exercise=null,this.generatedExercise=null,this.vf=null,this.registry=null,this.score=null,this.voice=null,this.beam=null,this.contentScaleFactor=1,this.useScaling=!0,this.assumedCanvasWidth=1024,this.barWidth=200,this.barHeight=160,this.firstBarAddition=40,this.barsPerLine=4,this.noteIDNumber=0,this.systems=Array(),this.setupOnElement=function(t){var e=document.getElementById(t).offsetWidth;this.useScaling&&(this.contentScaleFactor=e/this.assumedCanvasWidth,e=this.assumedCanvasWidth);var i=e-2*this.scorePositionInitialX;pm_log("Avail width: "+i),this.barWidth=i/this.barsPerLine,pm_log("Bar width: "+this.barWidth);var s=Math.ceil(this.exercise.bars.length/this.barsPerLine),n=this.barsPerLine*this.barWidth+this.firstBarAddition;s<=1&&(n=this.exercise.bars.length*this.barWidth+this.firstBarAddition),this.scorePositionInitialX=e/2-n/2,pm_log("Total width will be "+n),pm_log("Total height will be "+s*this.barHeight);var o=document.getElementById(indicatorCanvasName);o.width=e*this.contentScaleFactor,o.height=s*this.barHeight*this.contentScaleFactor,this.vf=new Vex.Flow.Factory({renderer:{selector:t,width:e*this.contentScaleFactor,height:s*this.barHeight*this.contentScaleFactor}}),this.vf.context.scale(this.contentScaleFactor,this.contentScaleFactor),this.registry=new VF.Registry,VF.Registry.enableDefaultRegistry(this.registry),this.score=this.vf.EasyScore({throwOnError:!0}),this.voice=this.score.voice.bind(this.score),this.notes=this.score.notes.bind(this.score),this.beam=this.score.beam.bind(this.score)},this.makeSystem=function(){this.positionInLine=this.measureCounter%this.barsPerLine;var t=this.barWidth;0==this.positionInLine&&(t+=this.firstBarAddition,this.scorePositionX=this.scorePositionInitialX,0==this.scorePositionY?this.scorePositionY=this.scorePositionInitialY:this.scorePositionY+=this.barHeight);var e=this.vf.System({x:this.scorePositionX,y:this.scorePositionY,width:t,spaceBetweenStaves:10});return this.measureCounter+=1,this.scorePositionX+=t,e},this.id=function(t){return this.registry.getElementById(t)},this.notateExercise=function(){for(barIndex in this.exercise.bars){var t=this.exercise.bars[barIndex],e=this.makeSystem();this.systems.push(e);var i=Array();for(groupIndex in t.groups){var s=t.groups[groupIndex],n="";for(var o in s.notes){var r=s.notes[o];o>0&&(n+=","),n+=r,n+='[id="note'+this.noteIDNumber+'"]',this.noteIDNumber++}var a={};void 0!=s.stem_direction&&(a.stem=s.stem_direction);var h=this.notes(n,a);!0===s.beam&&(h=this.beam(h)),i.push(h)}var c=e.addStave({voices:[this.voice(i.reduce(concat))]});if(void 0!=t.extra_attributes)for(attributeIndex in t.extra_attributes){var l=t.extra_attributes[attributeIndex];switch(l.name){case"time_signature":c.addTimeSignature(l.value);break;case"clef":c.addClef(l.value);break;case"key_signature":c.addKeySignature(l.value);break;default:pm_log("Unknown attribute",10)}}barIndex==this.exercise.bars.length-1&&c.setEndBarType(VF.Barline.type.END)}this.vf.draw(),VF.Registry.disableDefaultRegistry()},this.getElementsForBeat=function(t){var e=0,i=null,s=null,n=0,o=0,r=null;for(index in this.generatedExercise.notes){var a=this.generatedExercise.notes[index].duration;if(e<=t)i=index,s=index,n=e,lastNoteBeatPosition=e;else if(null==i&&(i=index,n=e),s=index,o=e,e>=t)break;e+=a}return((r=(t-n)/(o-n))<0||isNaN(r))&&(r=0),{currentItemIndex:i,nextItemIndex:s,percent:r}},this.getPositionForBeat=function(t){var e=this.getElementsForBeat(t),i=this.id("note"+e.currentItemIndex),s=this.id("note"+e.nextItemIndex),n=i.stave.getYForLine(0),o=this.middlePositionOfItem(i),r=this.middlePositionOfItem(s)-this.middlePositionOfItem(i);return i.stave.getBoundingBox().y!=s.stave.getBoundingBox().y&&(r=i.stave.end_x-this.middlePositionOfItem(i)),{x:o+r*e.percent,y:n}},this.middlePositionOfItem=function(t){return t.getAbsoluteX()+t.getBoundingBox().w/2},this.getBasicStave=function(){return this.systems[0].parts[0].stave},this.getStaveForBeat=function(t){var e=this.getElementsForBeat(t);return this.id("note"+e.currentItemIndex).stave},this.drawIndicatorLine=function(t,e){var i=this.getPositionForBeat(e),s=20*this.contentScaleFactor,n=this.getBasicStave(),o=n.getYForLine(4)-n.getYForLine(0),r=i.y-s,a=i.y+o+s;if(t.getContext){var h=t.getContext("2d");h.strokeStyle="#4990E2",h.lineWidth=3,h.beginPath(),h.moveTo(i.x*this.contentScaleFactor,a*this.contentScaleFactor),h.lineTo(i.x*this.contentScaleFactor,r*this.contentScaleFactor),h.closePath(),h.stroke()}},this.getFeedbackYPosition=function(t){return this.getBasicStave().height+t},this.drawFeedbackAtPosition=function(t,e,i,s){var n=t.getContext("2d");n.font="16px Arial",n.textAlign="center",n.textBaseline="top",n.fillText(e,i*this.contentScaleFactor,s*this.contentScaleFactor)},this.createFeedbackHTMLElement=function(t,e,i){var s=16*this.contentScaleFactor,n=document.createElement("div");n.className="feedbackItem",n.innerHTML=t.map(function(t){return'<span class="feedbackItemElement">'+t+"</span>"}).join(""),n.style.position="absolute",n.style.top=i*this.contentScaleFactor+"px",n.style.left=""+e*this.contentScaleFactor-s/2+"px",document.getElementById("notationBody").appendChild(n)}};